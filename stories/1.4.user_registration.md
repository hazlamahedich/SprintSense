# Story 1.4: User Registration

## Status
Done✅

## Story
**As a** new user,
**I want** to securely register for an account,
**so that** I can trust the system with my information.

## Acceptance Criteria
1. A new database migration is created for the `users` table.
2. Registration page exists.
3. Handles duplicate emails.
4. Passwords are hashed with `bcrypt`.
5. User created in DB.
6. User logged in and redirected.
7. Handles invalid input (e.g., invalid email format, weak password) with clear error messages.

## Tasks / Subtasks
- [x] **Task 1: Create User Model and Database Migration (AC: #1)** ✅
    - [x] Create a `User` model in `backend/app/infrastructure/database/models.py` with UUID, email, password_hash, full_name, timestamps.
    - [x] Generate a new Alembic migration script that creates the `users` table with unique email index.
- [x] **Task 2: Implement User Registration Endpoint (AC: #3, #4, #5, #7)** ✅
    - [x] Create a new endpoint `POST /api/v1/auth/register` in `backend/app/api/routers/auth.py`.
    - [x] The endpoint accepts a `UserRegisterRequest` schema with `email`, `password`, and `full_name`.
    - [x] Hash the password using `bcrypt` with secure salt rounds.
    - [x] Handle duplicate email addresses with proper HTTP 409 responses.
    - [x] Add comprehensive validation for email format and password strength (8+ chars, upper/lower/digit/special).
    - [x] Save the new user to the database via AuthService domain logic.
- [x] **Task 3: Create Registration Page (AC: #2)** ✅
    - [x] Create a new page component in `frontend/src/pages/auth/RegisterPage.tsx` with MUI components.
    - [x] The page contains a responsive form with `email`, `password`, `confirmPassword`, and `full_name` fields.
    - [x] The form submits requests to the `POST /api/v1/auth/register` endpoint with proper error handling.
- [x] **Task 4: Implement Login and Redirection (AC: #6)** ✅
    - [x] Upon successful registration, the user is automatically logged in with JWT token.
    - [x] The user is redirected to protected areas with authentication state managed by Zustand.
- [x] **Task 5: Create Tests (AC: #2, #3, #4, #5)** ✅
    - [x] Create comprehensive unit tests for password utilities, JWT tokens, and auth domain logic.
    - [x] Create integration tests for the registration endpoint covering all scenarios.
    - [x] Create component tests for the registration page with React Testing Library (16/16 tests passing).

## Dev Notes

### AI Prompt

**Role**: You are an expert full-stack developer.

**Context**: You are working on SprintSense, an AI-powered agile project management platform. The project uses a modular monolith architecture with a React frontend and a FastAPI backend. You need to implement the user registration feature.

**Task**: Implement the user registration feature as described in the acceptance criteria and the tasks in the "Tasks / Subtasks" section. All the necessary details for implementation are in the "Dev Notes" section.

**Quality Standards**:
- All code should adhere to the standards outlined in `docs/architecture/coding-standards.md`.

**Anti-Patterns**:
- Do not store passwords in plain text.
- Do not return the user's password in the API response.

**Validation**:
- All acceptance criteria must be met.
- All tests specified in the "Testing Requirements" section must pass.

### Previous Story Insights
The previous story (1.3) successfully set up API type generation. This means that the frontend can now rely on up-to-date TypeScript definitions for the backend API. This will be crucial for implementing the registration form and handling the API response.

### Data Models
The `User` model should be created with the following attributes:
- `id` (UUID)
- `displayName` (string)
- `email` (string)
- `avatarUrl` (string, optional)
- `password_hash` (string, backend-only)
- `created_at` (Date)
- `updated_at` (Date)

[Source: `docs/architecture/4-data-models.md`]

### API Specifications
A new endpoint `POST /api/v1/users` should be created. It should accept a JSON body with `email` and `password`.

[Source: `docs/architecture/5-api-specification.md`, `docs/architecture/7-core-workflows.md`]

### Component Specifications
The user registration functionality will be implemented within the existing `backend/app/api/v1/users.py` and a new frontend component at `frontend/src/pages/Register.tsx`. The core logic for user creation and password hashing will reside in the backend.

[Source: `docs/architecture/6-components.md`]

### File Locations
- **Backend Model:** `backend/app/domains/users/models.py`
- **Backend API:** `backend/app/api/v1/users.py`
- **Frontend Page:** `frontend/src/pages/Register.tsx`

[Source: `docs/architecture/11-unified-project-structure.md` - NOTE: The project structure in this document (`apps/api`, `apps/web`) does not match the actual project structure (`backend`, `frontend`). The file locations above are based on the actual structure.]

### Testing Requirements
- The testing strategy is outlined in `docs/architecture/testing-strategy.md`.
- Unit tests should be created for the user registration endpoint using `pytest`.
- Tests should cover successful registration, duplicate email handling, and password hashing.
- Frontend component tests should be created for the registration page using `vitest` and `React Testing Library`.
- Test data should include valid user credentials, an existing user's email for testing duplicate registration, and examples of invalid email formats and weak passwords.

### Coding Standards
- All code should adhere to the standards outlined in `docs/architecture/coding-standards.md`.
- Backend code should be formatted with `black` and `isort`.
- Frontend code should be formatted with `prettier`.

### Technical Constraints
- Passwords must be hashed using `bcrypt`. [Source: `docs/prd/6-epic-details.md`]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-15 | 2.0 | Story completed - All tasks implemented and tested. Full user registration system with JWT authentication, comprehensive validation, and 16/16 tests passing. | Dev Team |
| 2025-09-15 | 1.2 | Restored detailed Dev Notes and Tasks, and added a more detailed AI Prompt. | Sarah (PO) |
| 2025-09-15 | 1.1 | Updated story with feedback from validation. | Sarah (PO) |
| 2025-09-15 | 1.0 | Initial Draft | Bob (SM) |

## QA Results

### Review Date: 2025-09-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The implementation of the user registration feature is of high quality. The code is well-structured, clean, and follows the established architecture and coding standards. The separation of concerns between the frontend and backend is clear, and the use of a service layer in the backend is a good practice.

### Refactoring Performed
None required.

### Compliance Check
- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist
- [ ] Consider adding CSRF protection to the frontend.
- [ ] Consider adding more comprehensive logging on the frontend.

### Security Review
- The use of `bcrypt` for password hashing is a strong security measure.
- The system does not appear to be vulnerable to common injection attacks.
- As mentioned in the improvements checklist, CSRF protection should be considered.

### Performance Considerations
- No performance issues were identified during the review.

### Files Modified During Review
None.

### Gate Status
Gate: PASS → docs/qa/gates/1.4-user-registration.yml

### Recommended Status
[✓ Ready for Done]

