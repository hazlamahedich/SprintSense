# Story 2.3: Create Work Item

## Status
Draft

## Story
**As a** team member,
**I want** to create a new work item,
**so that** I can add new tasks and ideas to our team's backlog.

## Acceptance Criteria
1. "Create" button exists on the backlog page and is prominently displayed
2. Form has title (required) and description fields with proper validation
3. New item added to top of backlog with default status 'backlog'
4. View updates for all users in real-time or on refresh

## Tasks / Subtasks
- [ ] Create work item form component (AC: 1, 2)
  - [ ] Design and implement CreateWorkItemForm component with Material-UI styling
  - [ ] Add title field (required, max 200 characters) with validation
  - [ ] Add description field (optional, max 2000 characters) with text area
  - [ ] Add work item type selector (story, bug, task) with default 'story'
  - [ ] Implement form validation and error handling
  - [ ] Add submit and cancel buttons with proper loading states
- [ ] Integrate form with backend API (AC: 2, 3)
  - [ ] Create POST /teams/{teamId}/work-items API endpoint
  - [ ] Implement team membership authorization check
  - [ ] Add request/response validation with Pydantic models
  - [ ] Handle duplicate work item scenarios gracefully
- [ ] Add "Create Work Item" button to backlog page (AC: 1)
  - [ ] Add prominent floating action button or header button
  - [ ] Implement modal/dialog pattern for form display
  - [ ] Ensure accessibility with proper ARIA labels and keyboard navigation
- [ ] Update backlog view with new item (AC: 3, 4)
  - [ ] Refresh work items list after successful creation
  - [ ] Add new item to top of list with correct priority ordering
  - [ ] Show success notification to user
  - [ ] Clear form and close modal after successful submission
- [ ] Testing (All ACs)
  - [ ] Unit tests for CreateWorkItemForm component
  - [ ] Integration tests for POST endpoint with authorization
  - [ ] E2E tests for complete create work item flow
  - [ ] Error scenario testing (network failures, validation errors)

## Dev Notes

### Testing
**Requirements from Architecture:**
- **Backend**: 80% test coverage with pytest-cov
- **Frontend**: 70% test coverage with vitest
- **Test file naming**: `test_*.py` (backend), `*.test.ts[x]` (frontend)
- **Testing location**: `src/__tests__/` (frontend), `tests/` (backend)

**Testing frameworks to use:**
- Frontend: Vitest, React Testing Library
- Backend: pytest, httpx AsyncClient for API tests
- Mock dependencies using `unittest.mock` (backend) or `vi` (frontend)

### Previous Story Insights
From Story 2.2 (View Backlog):
- Team membership authorization pattern is established and working
- WorkItem data model is fully implemented and tested
- Backlog pagination and filtering infrastructure is in place
- Material-UI theme with custom colors and animations is established

### Data Models
[Source: docs/architecture/4-data-models.md#workitem-revised]

**WorkItem Schema:**
- `id` (UUID): Primary key, auto-generated
- `teamId` (FK): Links to Team entity, required for authorization
- `sprintId` (FK, nullable): Should be null for new backlog items
- `authorId` (FK): User who created the work item (current logged-in user)
- `assigneeId` (FK, nullable): Should be null for new items
- `type` (enum): 'story', 'bug', 'task' - user selectable
- `title` (string): Display title, required, max 200 characters
- `description` (string, nullable): Detailed description, optional, max 2000 characters
- `status` (enum): Should default to 'backlog' for new items
- `priority` (float): Auto-calculate as highest priority + 1 for top placement
- `storyPoints` (integer, nullable): Should be null for new items
- `completedAt` (Date, nullable): Should be null for new items
- `created_at` (Date): Auto-generated timestamp
- `updated_at` (Date): Auto-generated timestamp
- `sourceSprintIdForActionItem` (FK, nullable): Should be null for manually created items

### API Specifications
[Source: docs/architecture/5-api-specification.md#example-endpoints-work-items]

**Endpoint:** `POST /teams/{teamId}/work-items`
- **Authentication**: Secure HTTP-only cookies (already implemented)
- **Authorization**: User must be team member (reuse existing pattern)
- **Request Body**: CreateWorkItemRequest schema
- **Response**: 201 Created with WorkItem schema
- **Content-Type**: application/json

**Request Schema (CreateWorkItemRequest):**
```python
class CreateWorkItemRequest(BaseModel):
    title: str = Field(..., min_length=1, max_length=200)
    description: Optional[str] = Field(None, max_length=2000)
    type: WorkItemType = Field(default=WorkItemType.story)
    # teamId comes from URL path parameter
    # All other fields auto-generated or defaulted
```

**Response Schema:** Standard WorkItem object as defined in data models

### Component Specifications
[Source: docs/architecture/6-components.md, docs/architecture/coding-standards.md]

**Technology Stack:**
- React with function components only (no class components)
- Material-UI (MUI) for base components with custom theme
- Zustand for global state management if needed
- Form validation with react-hook-form or built-in validation
- TypeScript with strict null checks

**Component Structure:**
```
frontend/src/
├── components/feature/backlog/
│   ├── CreateWorkItemForm.tsx          # Main form component
│   ├── CreateWorkItemButton.tsx        # Trigger button component
│   └── CreateWorkItemModal.tsx         # Modal wrapper component
├── hooks/
│   └── useCreateWorkItem.ts            # Data mutation hook
├── services/
│   └── workItemService.ts              # API client (extend existing)
└── types/
    └── workItem.types.ts               # TypeScript interfaces (extend existing)
```

**Required Components:**
1. `CreateWorkItemButton` - Floating action button or prominent header button
2. `CreateWorkItemModal` - Modal dialog container with backdrop
3. `CreateWorkItemForm` - Form with title, description, type fields
4. Custom hook `useCreateWorkItem` - Handle API calls and state management

### File Locations
[Source: docs/architecture/11-unified-project-structure.md]

**Frontend Files (in /apps/web/src/):**
- `components/feature/backlog/CreateWorkItemForm.tsx` - Form component
- `components/feature/backlog/CreateWorkItemButton.tsx` - Trigger button
- `components/feature/backlog/CreateWorkItemModal.tsx` - Modal wrapper
- `hooks/useCreateWorkItem.ts` - API integration hook
- `services/workItemService.ts` - Extend existing service
- `types/workItem.types.ts` - Extend existing types

**Backend Files (in /apps/api/):**
- `app/routers/teams.py` - Add POST endpoint to existing router
- `app/services/work_item_service.py` - Add create_work_item method
- `app/schemas/work_item.py` - Add CreateWorkItemRequest schema
- `app/models/work_item.py` - Already exists, no changes needed

**Test Files:**
- `apps/web/src/__tests__/CreateWorkItemForm.test.tsx`
- `apps/web/src/__tests__/CreateWorkItemModal.test.tsx`
- `apps/api/tests/test_work_items_create.py`

### Technical Constraints
[Source: docs/architecture/coding-standards.md]

**Frontend Requirements:**
- Use TypeScript with strict null checks
- Function components only (ESLint: `react/prefer-stateless-function`)
- Custom hooks for data mutations (`useCreateWorkItem`)
- Proper error boundaries and loading states
- No `any` types (ESLint: `@typescript-eslint/no-explicit-any`)
- Creative UI design avoiding generic Material-UI defaults
- Custom color palette and micro-interactions required
- Form validation with proper error messages and accessibility

**Backend Requirements:**
- Full type annotations for all functions (mypy: `disallow_untyped_defs`)
- FastAPI dependency injection for database sessions (reuse existing pattern)
- Pydantic models for request/response validation
- Async/await for database operations
- Proper error handling with custom exceptions
- 88 character line length (Black formatter)
- snake_case naming convention

**Performance Requirements:**
- Form submission should complete in <1 second average
- Optimistic UI updates where possible
- Proper form validation to prevent unnecessary API calls
- Efficient re-rendering of backlog list after creation

**Security Requirements:**
- Team membership authorization before allowing creation
- Input sanitization and validation using Pydantic schemas
- Prevent XSS attacks through proper output encoding
- SQL injection prevention through parameterized queries

### Supabase Integration Notes
[Source: User rules - Local Supabase usage preference]
- Use local Supabase instance for development
- Leverage Supabase CLI for database schema management
- Consider using Supabase realtime features for live updates (future enhancement)
- Database migrations should be managed through existing Alembic setup

### Poetry Integration
[Source: User rules - Poetry for Python dependencies]
- Use `poetry run` prefix for all Python commands during development
- Add any new Python dependencies through `poetry add`
- Run tests with `poetry run pytest`
- Lint checks with `poetry run flake8` and `poetry run mypy`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-17 | 1.0 | Initial story creation for Epic 2 | Bob (SM) |

## Dev Agent Record

This section will be populated by the development agent during implementation.

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

This section will be filled by the QA Agent after implementation and testing.
