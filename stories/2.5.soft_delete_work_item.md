# Story 2.5: Soft-Delete Work Item

## Status
Approved

## Story
**As a** team member,
**I want** to safely delete a work item,
**so that** I can remove irrelevant items without fear of permanent data loss.

## Acceptance Criteria
1. "Delete" option exists on work item cards and detail views with accessible controls
2. Confirmation dialog shown before deletion to prevent accidental deletions
3. Item is marked as "archived" (soft delete) instead of permanent deletion
4. Archived view is out of scope for this story
5. Success notification confirms item was archived and provides clear user feedback
6. View updates immediately for all team members after archival
7. Archived items do not appear in regular backlog views
8. If archive operation fails, user receives clear error message and work item remains in original state

## Tasks / Subtasks
- [ ] Create soft-delete confirmation dialog component (AC: 1, 2)
  - [ ] Design ConfirmDeleteModal component with clear warning messaging
  - [ ] Add accessible dialog with focus trap and keyboard navigation
  - [ ] Include "Cancel" and "Archive Item" buttons with distinct styling
  - [ ] Implement proper ARIA labels and screen reader support
- [ ] Implement soft-delete backend logic (AC: 3, 7)
  - [ ] Create PATCH /teams/{teamId}/work-items/{workItemId}/archive API endpoint
  - [ ] Update work item status to 'archived' instead of deleting record
  - [ ] Implement team membership authorization check
  - [ ] Add request/response validation with Pydantic models
- [ ] Update frontend work item service (AC: 5, 6, 8)
  - [ ] Extend workItemService.ts with archiveWorkItem method
  - [ ] Implement optimistic UI updates with rollback capability
  - [ ] Add comprehensive error handling with user-friendly messages (AC: 8)
  - [ ] Handle structured error responses from backend API
- [ ] Add delete button UI integration (AC: 1, 6)
  - [ ] Integrate delete functionality with BacklogItem component
  - [ ] Add accessible "Delete" button with appropriate iconography
  - [ ] Implement confirmation flow triggering the modal
  - [ ] Handle loading states during archive operation
- [ ] Filter archived items from views (AC: 7)
  - [ ] Update backend work item queries to exclude archived items by default
  - [ ] Modify frontend work item list components to filter out archived items
  - [ ] Update work item state management to remove archived items
- [ ] Testing (All Components) (AC: 1-8)
  - [ ] Unit tests for ConfirmDeleteModal component including accessibility
  - [ ] Unit tests for PATCH /archive endpoint with authorization and error handling
  - [ ] Unit tests for workItemService.archiveWorkItem method including failure scenarios (AC: 8)
  - [ ] Integration tests for complete soft-delete workflow end-to-end
  - [ ] Test that archived items are properly filtered from views
  - [ ] Test error handling and rollback scenarios when archive operations fail

## Dev Notes

### Testing
**Requirements from Architecture:**
[Source: docs/architecture/coding-standards.md#testing-requirements]
- **Backend**: 80% test coverage with pytest-cov
- **Frontend**: 70% test coverage with vitest  
- **Test file naming**: `test_*.py` (backend), `*.test.tsx` (frontend)
- **Testing location**: `src/__tests__/` (frontend), `tests/` (backend)

**Testing frameworks to use:**
- Frontend: Vitest, React Testing Library
- Backend: pytest, httpx AsyncClient for API tests
- Mock dependencies using `unittest.mock` (backend) or `vi` (frontend)

### Previous Story Insights
From Story 2.4 (Edit Work Item):
- Work item PATCH endpoint patterns are established and can be reused
- Material-UI theme with custom colors and animations is working well
- Team membership authorization pattern is proven and tested
- WorkItem data model and API patterns are fully implemented
- Form validation and error handling patterns are established
- Optimistic UI update patterns with rollback are implemented

### Data Models
[Source: docs/architecture/4-data-models.md#workitem-revised]

**WorkItem Schema - Relevant Fields for Soft Delete:**
- `id` (UUID): Primary key, immutable after creation
- `teamId` (FK): Links to Team entity, required for authorization (immutable)
- `status` (enum): 'backlog', 'todo', 'in_progress', 'done', **'archived'** - will be set to 'archived'
- `updated_at` (Date): Auto-updated when status changes to archived
- All other fields remain unchanged during archival

**Key Implementation Notes:**
- The `status` field already supports 'archived' state according to data model
- No database schema changes required - existing enum supports archival
- Archived items should be excluded from default queries but remain in database

### API Specifications  
[Source: docs/architecture/5-api-specification.md#example-endpoints-work-items]

**New Endpoint:** `PATCH /teams/{teamId}/work-items/{workItemId}/archive`
- **Authentication**: Secure HTTP-only cookies (reuse existing pattern)
- **Authorization**: User must be team member (reuse existing pattern from Story 2.4)
- **Request Body**: Empty (no payload needed for archival)
- **Response**: 200 OK with updated WorkItem schema (status = 'archived')
- **Content-Type**: application/json

**Response Schema:**
```python
# Returns standard WorkItem schema with status = 'archived'
{
  "id": "uuid",
  "teamId": "uuid", 
  "status": "archived",
  "title": "string",
  "updated_at": "2025-09-19T10:17:45Z",
  # ... other WorkItem fields
}
```

### Component Specifications
[Source: docs/architecture/coding-standards.md, docs/architecture/3-tech-stack.md]

**Technology Stack:**
- React with function components only (no class components)
- Material-UI (MUI) for base components with custom theme
- TypeScript with strict null checks
- Zustand for global state management if needed

**Component Structure:**
```
frontend/src/
├── components/feature/backlog/
│   ├── ConfirmDeleteModal.tsx        # Confirmation dialog component
│   ├── DeleteWorkItemButton.tsx      # Delete trigger button component  
│   └── [existing components...]      # EditWorkItemForm, etc.
├── hooks/
│   ├── useArchiveWorkItem.ts         # Archive work item hook
│   └── [existing hooks...]           # useEditWorkItem, etc.
├── services/
│   └── workItemService.ts            # Extend with archiveWorkItem method
└── types/
    └── workItem.types.ts             # Extend existing types if needed
```

**Required Components:**
1. `DeleteWorkItemButton` - Delete button on work item cards
2. `ConfirmDeleteModal` - Confirmation dialog with clear messaging
3. Custom hook `useArchiveWorkItem` - Handle archive API calls and state management
4. Extended `workItemService` - Add archiveWorkItem method

### File Locations
[Source: docs/architecture/11-unified-project-structure.md]

**Frontend Files (in /apps/web/src/):**
- `components/feature/backlog/ConfirmDeleteModal.tsx` - Confirmation dialog
- `components/feature/backlog/DeleteWorkItemButton.tsx` - Delete trigger
- `hooks/useArchiveWorkItem.ts` - Archive API integration hook
- `services/workItemService.ts` - Extend existing service with archiveWorkItem method

**Backend Files (in /apps/api/):**
- `app/routers/teams.py` - Add PATCH /archive endpoint to existing router
- `app/services/work_item_service.py` - Add archive_work_item method
- `app/models/work_item.py` - Already supports 'archived' status, no changes needed

**Test Files:**
- `apps/web/src/__tests__/ConfirmDeleteModal.test.tsx`
- `apps/web/src/__tests__/DeleteWorkItemButton.test.tsx`  
- `apps/web/src/__tests__/useArchiveWorkItem.test.tsx`
- `apps/api/tests/test_work_items_archive.py`

### Technical Constraints
[Source: docs/architecture/coding-standards.md]

**Soft Delete Implementation:**
- Use existing WorkItem.status enum 'archived' value
- Implement optimistic UI updates with rollback capability
- Exclude archived items from default queries using WHERE status != 'archived'
- Maintain referential integrity - archived items keep all relationships

**Security Considerations:**
- Validate user authorization for both team membership and work item access
- Log all archive operations for audit trail
- Rate limiting on archive endpoints to prevent abuse
- Sanitize all input data to prevent XSS attacks

**Performance Requirements:**
- Confirmation dialog should render within 200ms
- Archive API response time should be under 500ms
- UI updates should propagate immediately to all team members
- Filtered queries should maintain performance with archived items excluded

**User Experience Requirements:**
- Clear confirmation dialog prevents accidental deletions
- Visual feedback during archive operation (loading states)
- Success notification confirms operation completion
- Accessible keyboard navigation for all delete controls

## QA Results

**QA Review Date**: 2025-09-19  
**QA Architect**: Quinn  
**Decision**: ✅ **APPROVED**

**Testability Assessment**: PASS  
- All 8 acceptance criteria are measurable and testable
- Test scenarios cover unit, integration, and error handling
- Test strategy aligns with architecture requirements

**Risk Profile**: ACCEPTABLE  
- Low risk: Established patterns, simple status update, existing auth
- Medium risk: Multi-user updates, query performance (mitigation strategies documented)

**Quality Attributes Validation**: PASS  
- Security: Authorization, audit trail, input sanitization ✓
- Performance: Specific targets defined (200ms/500ms) ✓
- Accessibility: ARIA, focus trap, keyboard navigation ✓

**Test Coverage**: COMPREHENSIVE  
- Unit tests for all components specified
- Integration tests for end-to-end workflow
- Error scenario testing (AC #8) included
- Architecture-compliant test structure and coverage targets

**Enhancement Recommendations** (Advisory):
- Performance testing under high concurrent usage
- Long-term database integrity testing for archived items
- Cross-browser accessibility validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial story creation | Bob (SM) |
| 2025-09-19 | 1.1 | PO review: Added AC #8 for error handling robustness | Sarah (PO) |
| 2025-09-19 | 1.2 | QA review: Approved with comprehensive quality validation | Quinn (QA) |
| 2025-09-19 | 2.0 | Status updated to Approved after passing PO and QA reviews | System |
