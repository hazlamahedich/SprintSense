# Story 2.6: Manual Prioritization

## Status
ðŸŸ¡ **DRAFT**

## Story
**As a** team member,
**I want** to manually and accessibly change the priority of work items,
**so that** I can organize the backlog.

## Acceptance Criteria
1. Uses accessible "Move to Top/Up/Down/Bottom" buttons
2. Saves change
3. View updates for all users

## Tasks / Subtasks
- [ ] Create accessible prioritization controls (AC: 1)
  - [ ] Design PriorityControls component with "Move to Top", "Move Up", "Move Down", "Move to Bottom" buttons
  - [ ] Implement proper ARIA labels and keyboard navigation support
  - [ ] Add clear visual indicators showing current position and available actions
  - [ ] Include confirmation feedback for screen readers
- [ ] Implement backend priority update logic (AC: 2)
  - [ ] Create PATCH /teams/{teamId}/work-items/{workItemId}/priority API endpoint
  - [ ] Update work item priority field with proper transaction handling
  - [ ] Implement team membership authorization check
  - [ ] Add request/response validation with Pydantic models
  - [ ] Handle priority reordering logic (recalculate other item priorities)
- [ ] Update frontend priority management (AC: 2, 3)
  - [ ] Extend workItemService.ts with updateWorkItemPriority method
  - [ ] Implement optimistic UI updates with rollback capability
  - [ ] Add comprehensive error handling with user-friendly messages
  - [ ] Handle real-time updates via WebSocket or polling mechanism
- [ ] Integrate priority controls with work item components (AC: 1, 3)
  - [ ] Add PriorityControls to BacklogItem component
  - [ ] Implement loading states during priority update operations
  - [ ] Handle priority change confirmation and user feedback
  - [ ] Ensure priority changes trigger view refresh for all team members
- [ ] Update work item display ordering (AC: 3)
  - [ ] Modify backend work item queries to order by priority
  - [ ] Update frontend work item list components to maintain priority order
  - [ ] Handle sorting and filtering with priority-based ordering
- [ ] Testing (All Components) (AC: 1-3)
  - [ ] Unit tests for PriorityControls component including accessibility
  - [ ] Unit tests for PATCH /priority endpoint with authorization and priority logic
  - [ ] Unit tests for workItemService.updateWorkItemPriority method including failure scenarios
  - [ ] Integration tests for complete priority change workflow end-to-end
  - [ ] Test that priority changes are properly reflected across all users
  - [ ] Test accessibility compliance with screen readers and keyboard navigation

## Dev Notes

### Testing
**Requirements from Architecture:**
[Source: docs/architecture/coding-standards.md#testing-requirements]
- **Backend**: 80% test coverage with pytest-cov
- **Frontend**: 70% test coverage with vitest  
- **Test file naming**: `test_*.py` (backend), `*.test.tsx` (frontend)
- **Testing location**: `src/__tests__/` (frontend), `tests/` (backend)

**Testing frameworks to use:**
- Frontend: Vitest, React Testing Library
- Backend: pytest, httpx AsyncClient for API tests
- Mock dependencies using `unittest.mock` (backend) or `vi` (frontend)

### Previous Story Insights
From Story 2.5 (Soft-Delete Work Item):
- Work item PATCH endpoint patterns are established and can be reused
- Material-UI theme with custom colors and animations is working well
- Team membership authorization pattern is proven and tested
- WorkItem data model and API patterns are fully implemented
- Optimistic UI update patterns with rollback are implemented
- Error handling and user feedback patterns are established

### Data Models
[Source: docs/architecture/4-data-models.md#workitem-revised]

**WorkItem Schema - Relevant Fields for Priority:**
- `id` (UUID): Primary key, immutable after creation
- `teamId` (FK): Links to Team entity, required for authorization (immutable)
- `priority` (float): Numeric priority value for ordering (will be updated)
- `updated_at` (Date): Auto-updated when priority changes
- All other fields remain unchanged during priority updates

**Key Implementation Notes:**
- The `priority` field is a float to allow for flexible reordering
- Priority updates should recalculate other item priorities to maintain proper ordering
- Use transaction handling to ensure atomic priority updates
- Consider using priority gaps (e.g., 1000, 2000, 3000) to minimize cascading updates

### API Specifications  
[Source: docs/architecture/5-api-specification.md#example-endpoints-work-items]

**New Endpoint:** `PATCH /teams/{teamId}/work-items/{workItemId}/priority`
- **Authentication**: Secure HTTP-only cookies (reuse existing pattern)
- **Authorization**: User must be team member (reuse existing pattern from Story 2.5)
- **Request Body**: `{"action": "move_to_top" | "move_up" | "move_down" | "move_to_bottom" | "set_position", "position"?: number}`
- **Response**: 200 OK with updated WorkItem schema (priority updated)
- **Content-Type**: application/json

**Response Schema:**
```python
# Returns standard WorkItem schema with updated priority
{
  "id": "uuid",
  "teamId": "uuid", 
  "priority": 1500.0,  # New priority value
  "title": "string",
  "updated_at": "2025-09-19T10:17:45Z",
  # ... other WorkItem fields
}
```

### Component Specifications
[Source: docs/architecture/coding-standards.md, docs/architecture/3-tech-stack.md]

**Technology Stack:**
- React with function components only (no class components)
- Material-UI (MUI) for base components with custom theme
- TypeScript with strict null checks
- Zustand for global state management if needed

**Component Structure:**
```
frontend/src/
â”œâ”€â”€ components/feature/backlog/
â”‚   â”œâ”€â”€ PriorityControls.tsx         # Priority control buttons component
â”‚   â”œâ”€â”€ PriorityButton.tsx           # Individual priority action button
â”‚   â””â”€â”€ [existing components...]     # BacklogItem, etc.
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePriorityUpdate.ts         # Priority update hook
â”‚   â””â”€â”€ [existing hooks...]          # useEditWorkItem, etc.
â”œâ”€â”€ services/
â”‚   â””â”€â”€ workItemService.ts           # Extend with updateWorkItemPriority method
â””â”€â”€ types/
    â””â”€â”€ workItem.types.ts            # Extend with priority action types
```

**Required Components:**
1. `PriorityControls` - Container for priority action buttons
2. `PriorityButton` - Individual action button (move up, down, etc.)
3. Custom hook `usePriorityUpdate` - Handle priority API calls and state management
4. Extended `workItemService` - Add updateWorkItemPriority method

### File Locations
[Source: docs/architecture/11-unified-project-structure.md]

**Frontend Files (in /apps/web/src/):**
- `components/feature/backlog/PriorityControls.tsx` - Priority control container
- `components/feature/backlog/PriorityButton.tsx` - Individual priority buttons
- `hooks/usePriorityUpdate.ts` - Priority update API integration hook
- `services/workItemService.ts` - Extend existing service with updateWorkItemPriority method
- `types/workItem.types.ts` - Add priority action types

**Backend Files (in /apps/api/):**
- `app/routers/teams.py` - Add PATCH /priority endpoint to existing router
- `app/services/work_item_service.py` - Add priority update methods
- `app/models/work_item.py` - Priority field already exists, no changes needed
- `app/schemas/work_item.py` - Add priority action request/response schemas

**Test Files:**
- `apps/web/src/__tests__/PriorityControls.test.tsx`
- `apps/web/src/__tests__/PriorityButton.test.tsx`  
- `apps/web/src/__tests__/usePriorityUpdate.test.tsx`
- `apps/api/tests/test_work_items_priority.py`

### Technical Constraints
[Source: docs/architecture/coding-standards.md]

**Priority Update Implementation:**
- Use float values for priority to allow flexible reordering
- Implement atomic transactions for priority updates
- Consider priority gaps (1000, 2000, 3000) to minimize cascading updates
- Handle edge cases like moving first/last items
- Maintain referential integrity during priority changes

**Accessibility Requirements:**
- All priority controls must be keyboard accessible
- Proper ARIA labels for screen readers ("Move work item up in priority")
- Focus management after priority changes
- Clear audio feedback for screen reader users
- Support standard keyboard shortcuts (Ctrl+Up/Down for priority)

**Performance Requirements:**
- Priority controls should render within 200ms
- Priority update API response time should be under 500ms
- UI updates should propagate immediately to all team members
- Optimistic updates should provide immediate feedback
- Rollback mechanism for failed priority updates

**User Experience Requirements:**
- Clear visual feedback during priority operations (loading states)
- Success notification confirms operation completion
- Error messages provide clear guidance for resolution
- Consistent button styling with existing MUI theme
- Intuitive button placement and grouping

**Security Considerations:**
- Validate user authorization for both team membership and work item access
- Sanitize all input data to prevent XSS attacks
- Rate limiting on priority endpoints to prevent abuse
- Log all priority operations for audit trail

### Supabase Development Notes
[Source: User Rules - 89So90gDNXHlLoATczmZRE]
- Use local Supabase instance for development
- Leverage Supabase CLI for database management
- Ensure priority update operations work with local Supabase setup
- Test real-time functionality with Supabase WebSocket connections

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-19 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent upon completion*
