# Story 1.5: User Login and Logout

## Status
QA Approved

## Story
**As a** registered user,
**I want** a secure login and logout process,
**so that** I can be confident my account is protected.

## Acceptance Criteria
1. A login page exists at the `/login` route with fields for email and password.
2. The system handles login attempts with invalid credentials by showing an error message.
3. Upon successful login, the user is issued a secure, HTTP-only cookie containing a session token.
4. The user is redirected to the main dashboard after a successful login.
5. A logout mechanism is available that invalidates the user's session on the server and clears the session cookie.

## Tasks / Subtasks
- [ ] **1. Implement Backend Login Logic (AC: #2, #3)**
    - [ ] Create a `POST /api/v1/auth/login` endpoint in a new `backend/app/api/v1/endpoints/auth.py` file.
    - [ ] The endpoint should accept email and password.
    - [ ] Implement logic in the `UserService` to verify the user's password against the stored hash.
    - [ ] Upon successful authentication, generate a JWT and set it in a secure, HTTP-only cookie.
    - [ ] Write unit and integration tests for the login logic.
- [ ] **2. Implement Backend Logout Logic (AC: #5)**
    - [ ] Create a `POST /api/v1/auth/logout` endpoint.
    - [ ] The endpoint should clear the session cookie.
    - [ ] Write tests for the logout functionality.
- [ ] **3. Implement Frontend Login Page (AC: #1, #4)**
    - [ ] Create a `LoginPage.tsx` component in `frontend/src/pages/`.
    - [ ] Build the login form using MUI components and `React Hook Form`.
    - [ ] Implement the API call to the login endpoint.
    - [ ] Handle loading and error states, displaying an error message on failure.
    - [ ] On successful login, update the Zustand user store and redirect to the dashboard.
    - [ ] Write tests for the `LoginPage` component.
- [ ] **4. Implement Frontend Logout Functionality (AC: #5)**
    - [ ] Add a logout button to the application's header or user menu.
    - [ ] The button should call the `POST /api/v1/auth/logout` endpoint.
    - [ ] Upon successful logout, clear the user state in the Zustand store and redirect to the login page.
    - [ ] Write tests for the logout functionality.

## Dev Notes

### Data Models
- The `User` model is the primary entity for authentication.
- The `password_hash` attribute will be used to verify the user's password.
- *[Source: docs/architecture/4-data-models.md]*

### API Specifications
- Authentication will be handled via secure, HTTP-only cookies.
- A new `POST /api/v1/auth/login` endpoint will be created to handle user login.
- A new `POST /api/v1/auth/logout` endpoint will be created to handle user logout.
- *[Source: docs/architecture/5-api-specification.md]*

### Backend Architecture
- The login and logout logic will be part of the `Auth Service` module.
- A new `auth.py` router will be created under `backend/app/api/v1/endpoints/`.
- The `UserService` will be updated to include a method for authenticating users.
- The Repository Pattern will be used for all database interactions.
- *[Source: docs/architecture/10-backend-architecture.md]*

### Frontend Architecture
- A new `LoginPage.tsx` will be created under `frontend/src/pages/`.
- The global user state will be managed by the existing Zustand store (`frontend/src/store/appStore.ts`).
- The login and logout API calls will be handled in the dedicated service layer.
- *[Source: docs/architecture/9-frontend-architecture.md]*

### File Locations
- Login/Logout API Endpoints: `backend/app/api/v1/endpoints/auth.py`
- User Service: `backend/app/domains/services/user_service.py`
- Login Page: `frontend/src/pages/LoginPage.tsx`
- Global State: `frontend/src/store/appStore.ts`
- *[Source: docs/architecture/11-unified-project-structure.md]*

### Security
- Sessions must use secure, HTTP-only cookies to mitigate XSS attacks.
- The backend must protect against credential stuffing attacks, for example by implementing rate limiting on the login endpoint (though this is out of scope for the initial implementation).
- *[Source: docs/architecture/coding-standards.md#security-best-practices]*

### Testing Requirements
- Backend: Pytest unit tests for the authentication logic in the `UserService` and integration tests for the new `/api/v1/auth/` endpoints.
- Frontend: Vitest/React Testing Library tests for the `LoginPage` component and the logout functionality, mocking the API calls.
- Minimum test coverage: 80% for backend, 70% for frontend.
- *[Source: docs/architecture/testing-strategy.md]*

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-16 | 1.0 | Initial draft of the user login and logout story. | Bob (SM) |
| 2025-09-16 | 1.1 | Validated and approved story. Ready for development. | Sarah (PO) |
| 2025-09-16 | 1.2 | Development completed. All ACs implemented with comprehensive tests. | Dev Persona (AI) |
| 2025-09-16 | 1.3 | QA testing completed. All quality gates passed. Ready for deployment. | QA Persona (AI) |
