# Story 2.4: Edit Work Item

## Status
Draft

## Story
**As a** team member,
**I want** to edit an existing work item,
**so that** I can update its details as requirements change.

## Acceptance Criteria
1. "Edit" option exists on work item cards and detail views with accessible controls
2. Shows "user is editing" message to other team members to prevent editing conflicts  
3. Form saves changes and broadcasts updates to all connected users in real-time
4. Form validation prevents saving invalid data (empty title, exceeded character limits)
5. Success notification confirms changes were saved and error handling provides clear user feedback
6. Updated work item reflects changes immediately in all team members' views
7. Edit form pre-populates with current work item data and handles concurrent edit scenarios gracefully

## Tasks / Subtasks
- [ ] Create edit work item form component (AC: 1, 4, 7)
  - [ ] Design EditWorkItemForm component with pre-populated fields and validation
  - [ ] Add form fields: title (required, max 200 chars), description (optional, max 2000 chars), type selector
  - [ ] Implement comprehensive form validation with real-time feedback
  - [ ] Add save and cancel buttons with loading states
  - [ ] Handle form pre-population from existing work item data
- [ ] Implement edit conflict detection and messaging (AC: 2, 7)
  - [ ] Create real-time editing status tracking system
  - [ ] Display "User X is editing" banner/indicator to other team members
  - [ ] Handle concurrent edit scenarios with clear user messaging
  - [ ] Implement optimistic locking or last-writer-wins strategy
- [ ] Integrate form with backend API (AC: 3, 5, 6)
  - [ ] Create PATCH /teams/{teamId}/work-items/{workItemId} API endpoint
  - [ ] Implement team membership authorization check and ownership validation
  - [ ] Add request/response validation with Pydantic models
  - [ ] Handle edit conflicts and concurrent modification scenarios
- [ ] Add real-time updates and notifications (AC: 3, 5, 6)
  - [ ] Broadcast work item changes to all connected team members
  - [ ] Update work item lists and detail views in real-time
  - [ ] Show success/error notifications with clear messaging
  - [ ] Implement WebSocket or Server-Sent Events for live updates
- [ ] Testing (All Components)
  - [ ] Unit tests for EditWorkItemForm component including validation and conflict scenarios
  - [ ] Integration tests for PATCH endpoint with authorization and concurrent access
  - [ ] Unit tests for real-time update broadcasting system
  - [ ] End-to-end tests for complete edit workflow including conflict detection

## Dev Notes

### Testing
**Requirements from Architecture:**
- **Backend**: 80% test coverage with pytest-cov
- **Frontend**: 70% test coverage with vitest  
- **Test file naming**: `test_*.py` (backend), `*.test.tsx` (frontend)
- **Testing location**: `src/__tests__/` (frontend), `tests/` (backend)

**Testing frameworks to use:**
- Frontend: Vitest, React Testing Library
- Backend: pytest, httpx AsyncClient for API tests
- Mock dependencies using `unittest.mock` (backend) or `vi` (frontend)

### Previous Story Insights
From Story 2.3 (Create Work Item):
- Work item creation workflow and validation patterns are established
- Material-UI theme with custom colors and animations is working well
- Team membership authorization pattern is proven and tested
- WorkItem data model and API patterns are fully implemented
- Form validation and error handling patterns are established

### Data Models
[Source: docs/architecture/4-data-models.md#workitem-revised]

**WorkItem Schema:**
- `id` (UUID): Primary key, immutable after creation
- `teamId` (FK): Links to Team entity, required for authorization (immutable)
- `sprintId` (FK, nullable): Can be updated during editing
- `authorId` (FK): User who created the work item (immutable)
- `assigneeId` (FK, nullable): Can be updated during editing
- `type` (enum): 'story', 'bug', 'task' - user can change this
- `title` (string): Display title, required, max 200 characters - main editable field
- `description` (string, nullable): Detailed description, optional, max 2000 characters - main editable field
- `status` (enum): 'backlog', 'todo', 'in_progress', 'done', 'archived' - can be updated
- `priority` (float): Can be updated during editing
- `storyPoints` (integer, nullable): Can be updated during editing
- `completedAt` (Date, nullable): System managed, not directly editable
- `created_at` (Date): Immutable timestamp
- `updated_at` (Date): Auto-updated on each edit
- `sourceSprintIdForActionItem` (FK, nullable): Generally immutable

### API Specifications  
[Source: docs/architecture/5-api-specification.md#example-endpoints-work-items]

**Endpoint:** `PATCH /teams/{teamId}/work-items/{workItemId}`
- **Authentication**: Secure HTTP-only cookies (already implemented)
- **Authorization**: User must be team member (reuse existing pattern)
- **Request Body**: UpdateWorkItemRequest schema (partial updates supported)
- **Response**: 200 OK with updated WorkItem schema
- **Content-Type**: application/json

**Request Schema (UpdateWorkItemRequest):**
```python
class UpdateWorkItemRequest(BaseModel):
    title: Optional[str] = Field(None, min_length=1, max_length=200)
    description: Optional[str] = Field(None, max_length=2000)
    type: Optional[WorkItemType] = None
    status: Optional[WorkItemStatus] = None
    assigneeId: Optional[str] = None
    storyPoints: Optional[int] = Field(None, ge=0, le=100)
    priority: Optional[float] = None
    # Only include fields that are actually being updated
```

### Component Specifications
[Source: docs/architecture/6-components.md, docs/architecture/coding-standards.md]

**Technology Stack:**
- React with function components only (no class components)
- Material-UI (MUI) for base components with custom theme
- Zustand for global state management if needed
- Form validation with react-hook-form or built-in validation
- TypeScript with strict null checks

**Component Structure:**
```
frontend/src/
├── components/feature/backlog/
│   ├── EditWorkItemForm.tsx          # Main edit form component
│   ├── EditWorkItemButton.tsx        # Edit trigger button component
│   ├── EditWorkItemModal.tsx         # Modal wrapper component
│   ├── WorkItemEditingIndicator.tsx  # "User is editing" indicator
│   └── WorkItemConflictResolver.tsx  # Conflict resolution UI
├── hooks/
│   ├── useEditWorkItem.ts            # Data mutation hook
│   ├── useWorkItemLocking.ts         # Edit conflict management hook
│   └── useRealTimeUpdates.ts         # WebSocket/SSE hook for live updates
├── services/
│   └── workItemService.ts            # API client (extend existing)
└── types/
    └── workItem.types.ts             # TypeScript interfaces (extend existing)
```

**Required Components:**
1. `EditWorkItemButton` - Edit button on work item cards
2. `EditWorkItemModal` - Modal dialog container with form
3. `EditWorkItemForm` - Form with editable fields and validation
4. `WorkItemEditingIndicator` - Shows when other users are editing
5. Custom hook `useEditWorkItem` - Handle API calls and state management
6. Custom hook `useWorkItemLocking` - Manage edit conflicts and locking

### File Locations
[Source: docs/architecture/11-unified-project-structure.md]

**Frontend Files (in /apps/web/src/):**
- `components/feature/backlog/EditWorkItemForm.tsx` - Main form component
- `components/feature/backlog/EditWorkItemButton.tsx` - Edit trigger
- `components/feature/backlog/EditWorkItemModal.tsx` - Modal wrapper  
- `components/feature/backlog/WorkItemEditingIndicator.tsx` - Conflict indicator
- `hooks/useEditWorkItem.ts` - API integration hook
- `hooks/useWorkItemLocking.ts` - Edit conflict management
- `services/workItemService.ts` - Extend existing service with PATCH method
- `types/workItem.types.ts` - Extend existing types

**Backend Files (in /apps/api/):**
- `app/routers/teams.py` - Add PATCH endpoint to existing router
- `app/services/work_item_service.py` - Add update_work_item method
- `app/schemas/work_item.py` - Add UpdateWorkItemRequest schema
- `app/models/work_item.py` - Already exists, may need minor updates
- `app/services/websocket_service.py` - For real-time update broadcasting

**Test Files:**
- `apps/web/src/__tests__/EditWorkItemForm.test.tsx`
- `apps/web/src/__tests__/EditWorkItemModal.test.tsx`
- `apps/web/src/__tests__/WorkItemEditingIndicator.test.tsx`
- `apps/api/tests/test_work_items_edit.py`

### Technical Constraints
[Source: docs/architecture/coding-standards.md]

**Conflict Resolution Strategy:**
- Implement optimistic UI updates with rollback capability
- Use "last writer wins" approach with user confirmation for conflicts
- Display clear messaging when concurrent edits are detected
- Consider implementing WebSocket connections for real-time collaboration indicators

**Security Considerations:**
- Validate user authorization for both team membership and work item access
- Sanitize all input data to prevent XSS attacks
- Implement rate limiting on edit endpoints to prevent abuse
- Log all edit operations for audit trail

**Performance Requirements:**
- Edit form should render within 200ms
- API response time should be under 500ms for updates
- Real-time updates should propagate within 1 second
- Form validation should provide immediate feedback without API calls

### Supabase Integration Notes
[Source: User Rule - Local Supabase Instance]

The user prefers to use a local Supabase instance with Supabase CLI and MCP tools:
- Ensure all database operations work with local Supabase setup
- Use Supabase's real-time functionality for live update broadcasting
- Implement Row Level Security (RLS) policies for work item access control
- Test with local Supabase CLI tools during development

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-09-18 | 1.0 | Initial story draft created | SM (Bob) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here after implementation*
